{% extends "shop/base.html" %}
{% load humanize %}
{% load i18n %}
{% block title %}{% trans "–ì–ª–∞–≤–Ω–∞—è" %} - {% trans "–ú–∞–≥–∞–∑–∏–Ω" %}{% endblock %}
{% block content %}

<!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω -->
<form id="search-form" method="get" style="display:flex; gap:8px; align-items:center; padding:12px 24px; margin-bottom:20px; flex-wrap:wrap;">
    <input type="text" name="search" id="search-input" placeholder="üîç {% trans '–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞...' %}" value="{{ search }}" 
           style="flex:1; min-width:200px; padding:8px 12px; border:1.5px solid #e5e7eb; border-radius:8px; font-size:13px; 
                  transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05); background:white;"
           onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 2px 8px rgba(59,130,246,0.15)';"
           onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';"
           onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)';"
           onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">
    
    <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –∫–∞–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–æ–≤ -->
    <div class="filter-switcher" style="height:32px; display:flex; align-items:center;">
        <select name="price_filter" id="price-filter" 
                style="padding:6px 8px; border-radius:6px; border:1px solid rgba(59,130,246,0.3); cursor:pointer; font-weight:600; 
                       background:linear-gradient(135deg, rgba(59,130,246,0.2) 0%, rgba(59,130,246,0.15) 100%); color:#2563eb; 
                       transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(59,130,246,0.1); font-size:12px; height:32px; 
                       line-height:1.5; appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%232563eb%22 stroke-width=%222%22%3e%3cpolyline points=%226 9 12 15 18 9%22%3e%3c/polyline%3e%3c/svg%3e'); 
                       background-repeat: no-repeat; background-position: right 6px center; background-size: 14px; padding-right: 24px;"
                onchange="document.getElementById('search-form').submit();"
                onmouseover="this.style.background='linear-gradient(135deg, rgba(59,130,246,0.3) 0%, rgba(59,130,246,0.25) 100%)'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.2)';"
                onmouseout="this.style.background='linear-gradient(135deg, rgba(59,130,246,0.2) 0%, rgba(59,130,246,0.15) 100%)'; this.style.boxShadow='0 2px 8px rgba(59,130,246,0.1)';">
            <option value="" style="background:#2c3e7f; color:white;">{% trans "–í—Å–µ —Ç–æ–≤–∞—Ä—ã" %}</option>
            <option value="cheap" {% if price_filter == 'cheap' %}selected{% endif %} style="background:#2c3e7f; color:white;">{% trans "–î–µ—à–µ–≤—ã–µ" %}</option>
            <option value="expensive" {% if price_filter == 'expensive' %}selected{% endif %} style="background:#2c3e7f; color:white;">{% trans "–î–æ—Ä–æ–≥–∏–µ" %}</option>
        </select>
    </div>
</form>

<script>
// Auto-submit search input with debounce (500ms delay)
let searchTimeout;
document.getElementById('search-input').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        document.getElementById('search-form').submit();
    }, 500);
});
</script>

{% if products %}
<div class="products">
    {% for p in products %}
    <div class="product-card" data-id="{{ p.pk }}" style="cursor:pointer;">
        <div class="photo">
            <img src="{{ p.photo.url }}" alt="{{ p.name }}" />
        </div>
        <div class="info">
            <h3>{{ p.name }}</h3>
            <div class="product-meta">
                <div style="font-size:12px; line-height:1.6; color:#555;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                        <span style="color:#666; font-weight:500;">{% trans "–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å" %}:</span>
                        <span style="color:#222; font-weight:600;">{{ p.manufacturer }}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                        <span style="color:#666; font-weight:500;">{% trans "–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞" %}:</span>
                        <span style="color:#222; font-weight:600;">{{ p.release_date|date:"Y" }}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:#666; font-weight:500;">{% trans "–í–µ—Å" %}:</span>
                        <span style="color:#222; font-weight:600;">{{ p.weight }} {% trans "–∫–≥" %}</span>
                    </div>
                </div>
            </div>
            <p class="price-line">
                {% if p.previous_price %}
                    <span class="old-price">{{ p.previous_price|floatformat:0|intcomma }} ‚Ç∏</span>
                    <span class="new-price">{{ p.price|floatformat:0|intcomma }} ‚Ç∏</span>
                {% else %}
                    <span class="normal-price">{{ p.price|floatformat:0|intcomma }} ‚Ç∏</span>
                {% endif %}
            </p>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            {% if user.is_authenticated %}
                {% if user.profile.role != "admin" %}
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å/–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
                    <div style="display:flex; gap:8px; flex:1; align-items:center;">
                        <button type="button" class="btn-add-cart no-modal" data-product-id="{{ p.pk }}" style="flex:1; padding:8px 15px; background:#27ae60; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:500; transition:all 0.2s;">{% trans "–î–æ–±–∞–≤–∏—Ç—å" %}</button>
                        <div class="cart-quantity" data-product-id="{{ p.pk }}" style="display:none; gap:6px; align-items:center;">
                            <button type="button" class="qty-btn qty-minus no-modal" data-product-id="{{ p.pk }}" style="width:28px; height:28px; padding:0; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:6px; cursor:pointer; font-weight:600;">‚àí</button>
                            <span class="qty-value" style="min-width:28px; text-align:center; font-weight:600;">1</span>
                            <button type="button" class="qty-btn qty-plus no-modal" data-product-id="{{ p.pk }}" style="width:28px; height:28px; padding:0; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:6px; cursor:pointer; font-weight:600;">+</button>
                        </div>
                    </div>
                    <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->
                    <button type="button" class="btn-wishlist no-modal" data-product-id="{{ p.pk }}" style="width:36px; height:36px; padding:0; background:#f8d7da; border:1px solid #f5c6cb; border-radius:6px; cursor:pointer; font-size:16px; transition:all 0.2s; display:flex; align-items:center; justify-content:center;">‚ô°</button>
                </div>
                {% endif %}
            {% endif %}

        {% if user.is_authenticated and user.profile.role == "admin" %}
        <p class="actions">
            <a class="action-edit" href="{% url 'shop:product_edit' p.pk %}">{% trans "–ò–∑–º–µ–Ω–∏—Ç—å" %}</a>
            <a class="action-delete" href="javascript:void(0)" data-delete-url="{% url 'shop:product_delete' p.pk %}" onclick="openConfirm(this.dataset.deleteUrl)">{% trans "–£–¥–∞–ª–∏—Ç—å" %}</a>
        </p>
        {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>{% trans "–ü–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤." %}</p>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="confirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
        <div style="background:white; padding:24px; border-radius:12px; width:340px; text-align:center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
        <h3 style="color:#1f2937; font-size:18px; margin:0 0 12px 0;">{% trans "–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?" %}</h3>
        <p style="color:#6b7280; margin:0 0 20px 0; font-size:14px;">{% trans "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å." %}</p>
        <form id="deleteForm" method="post" style="display:flex; flex-direction:column; gap:10px;">
            {% csrf_token %}
            <button class="btn-del" id="deleteBtnSubmit" type="submit">{% trans "–î–∞, —É–¥–∞–ª–∏—Ç—å" %}</button>
        </form>
        <button class="btn-cancel" onclick="closeConfirm()">{% trans "–û—Ç–º–µ–Ω–∞" %}</button>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø–∏—Å–∞–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É -->
<div id="descriptionModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; width:400px; text-align:left; max-height:90vh; overflow-y:auto;">
        <h3 id="descTitle"></h3>
        <p id="descText"></p>
        
        <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞ -->
        <div style="background:#f9f9f9; padding:14px; border-radius:8px; margin:15px 0; border:1px solid #ddd;">
            <div style="font-size:13px; line-height:1.8; color:#333;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span style="color:#555; font-weight:600;">{% trans "–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å" %}:</span>
                    <span id="descManufacturer" style="color:#111; font-weight:600;"></span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span style="color:#555; font-weight:600;">{% trans "–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞" %}:</span>
                    <span id="descYear" style="color:#111; font-weight:600;"></span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span style="color:#555; font-weight:600;">{% trans "–í–µ—Å" %}:</span>
                    <span id="descWeight" style="color:#111; font-weight:600;"></span>
                </div>
                <div style="display:flex; justify-content:space-between; border-top:1px solid #ddd; padding-top:8px;">
                    <span style="color:#555; font-weight:700;">{% trans "–¶–µ–Ω–∞" %}:</span>
                    <span id="descPrice" style="color:#e74c3c; font-size:1.15em; font-weight:700;"></span>
                </div>
            </div>
        </div>
        
        <img id="descPhoto" src="" style="width:100%; margin-top:10px; border-radius:5px;" />
        
        <!-- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω -->
        {% if not user.is_authenticated %}
        <div style="margin-top:10px; padding:10px; background:#f0f0f0; border-radius:5px;">
            <p>{% trans "–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É." %}</p>
            <a href="{% url 'shop:login' %}?next={{ request.path }}" style="margin-right:10px;">{% trans "–í—Ö–æ–¥" %}</a>
            <a href="{% url 'shop:register' %}">{% trans "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" %}</a>
        </div>
        {% else %}
            <!-- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä -->
            {% if user.profile.role == "admin" %}
            <p style="margin-top:10px; color:#999;">{% trans "–í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä –∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–ø–∏—Å–∫–∞." %}</p>
            {% else %}
            <!-- –ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
            <form method="post" id="addToCartForm">
                {% csrf_token %}
                <button type="submit" style="margin-top:10px;">{% trans "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É" %}</button>
            </form>
            <button type="button" id="modalWishlistBtn" class="btn-wishlist no-modal" style="margin-top:10px; width:36px; height:36px; padding:0; background:#f8d7da; border:1px solid #f5c6cb; border-radius:6px; cursor:pointer; font-size:16px; display:inline-flex; align-items:center; justify-content:center;">‚ô°</button>
            {% endif %}
        {% endif %}
        
        <button onclick="closeDescription()" style="margin-top:10px;">{% trans "–ó–∞–∫—Ä—ã—Ç—å" %}</button>
    </div>
</div>

<script>
// –ú–æ–¥–∞–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
function openConfirm(url) {
    document.getElementById("confirmModal").style.display = "flex";
    document.getElementById("deleteForm").action = url;
}
function closeConfirm() {
    document.getElementById("confirmModal").style.display = "none";
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function toggleWishlist(productId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    // Get current language from URL path
    const prefix = getLangPrefix();
    
    fetch(`${prefix}/wishlist/toggle/${productId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const btn = document.querySelector(`.btn-wishlist[data-product-id="${productId}"]`);
            if (btn) {
                if (data.in_wishlist) {
                    btn.style.background = '#d32f2f';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#f8d7da';
                    btn.style.color = '#721c24';
                }
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

// –ú–æ–¥–∞–ª–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è –∏ –∫–æ—Ä–∑–∏–Ω—ã
document.querySelectorAll(".product-card").forEach(card => {
    card.addEventListener("click", (event) => {
        // Don't open description modal if the click originated on a link, button, or inside the actions/cart controls
        if (event.target.closest('a, button') || event.target.closest('.actions') || event.target.closest('.cart-quantity') || event.target.closest('.no-modal')) {
            return;
        }
        const productId = card.dataset.id;
        fetch(`/product/${productId}/json/`)
            .then(res => {
                if (!res.ok) {
                    console.error('Failed to fetch product data:', res.status);
                    return;
                }
                return res.json();
            })
            .then(data => {
                if (!data) return;
                document.getElementById("descTitle").innerText = data.name;
                document.getElementById("descText").innerText = data.description;
                document.getElementById("descManufacturer").innerText = data.manufacturer;
                // Extract year from release_date (format: YYYY-MM-DD)
                const year = new Date(data.release_date).getFullYear();
                document.getElementById("descYear").innerText = year;
                document.getElementById("descWeight").innerText = data.weight + " –∫–≥";
                document.getElementById("descPrice").innerText = parseInt(data.price).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + " ‚Ç∏";
                document.getElementById("descPhoto").src = data.photo;
                // Set add-to-cart form action only if the form exists on the page
                const form = document.getElementById("addToCartForm");
                if (form) {
                    form.action = `/cart/add/${data.id}/`;
                }

                // Setup wishlist button inside modal (if present and user authenticated)
                const modalWishlist = document.getElementById('modalWishlistBtn');
                if (modalWishlist) {
                    modalWishlist.setAttribute('data-product-id', data.id);
                    // copy visual state from main page wishlist button if available
                    const mainBtn = document.querySelector(`.btn-wishlist[data-product-id="${data.id}"]`);
                    if (mainBtn) {
                        modalWishlist.textContent = mainBtn.textContent;
                        modalWishlist.style.background = mainBtn.style.background;
                        modalWishlist.style.color = mainBtn.style.color;
                        modalWishlist.style.borderColor = mainBtn.style.borderColor;
                    }
                    // ensure clicking the modal wishlist button doesn't close modal
                    modalWishlist.onclick = function(e){
                        e.stopPropagation();
                        toggleWishlistNew(data.id, this);
                    };
                }
                document.getElementById("descriptionModal").style.display = "flex";
            })
            .catch(err => console.error('Error loading product:', err));
    });
});
function closeDescription() {
    document.getElementById("descriptionModal").style.display = "none";
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É —á–µ—Ä–µ–∑ AJAX
function addToCartAJAX(productId, productName) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    const btn = document.querySelector(`.btn-add-cart[data-product-id="${productId}"]`);
    if (!btn) return;
    
    // Disable button and show loading state
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.style.opacity = '0.7';
    btn.textContent = '‚è≥ {% trans "–î–æ–±–∞–≤–ª—è—é..." %}';
    
    fetch(`/cart/add/${productId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.textContent = originalText;
        
        if (data.success) {
            showToast(data.message, '{% trans "–û—Ç–∫—Ä—ã—Ç—å" %}', data.cart_url, 'success');
        } else {
            showToast(data.message, null, null, 'error');
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.textContent = originalText;
        console.error('Error:', error);
        showToast('{% trans "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏" %}', null, null, 'error');
    });
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–∫–Ω–∞
window.onclick = function(event) {
    const modal = document.getElementById("descriptionModal");
    if (event.target == modal) {
        modal.style.display = "none";
    }
    const confirmModal = document.getElementById("confirmModal");
    if (event.target == confirmModal) {
        confirmModal.style.display = "none";
    }
}

// ===== –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –ö–û–†–ó–ò–ù–´ –ò –ò–ó–ë–†–ê–ù–ù–û–ì–û =====

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadCartState();
    loadWishlistState();
    setupCartControls();
    setupWishlistButtons();
});

function getLangPrefix() {
    const parts = window.location.pathname.split('/');
    const lang = parts[1] || '';
    return lang ? `/${lang}` : '';
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
function loadCartState() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    const prefix = getLangPrefix();
    fetch(`${prefix}/cart/state/`, {
        method: 'GET',
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.items) {
            Object.keys(data.items).forEach(productId => {
                updateCartUIForProduct(parseInt(productId), data.items[productId]);
            });
        }
    })
    .catch(err => console.error('Error loading cart:', err));
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function loadWishlistState() {
    const prefix = getLangPrefix();
    fetch(`${prefix}/wishlist/state/`, {
        method: 'GET',
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.wishlist_ids) {
            data.wishlist_ids.forEach(productId => {
                const btn = document.querySelector(`.btn-wishlist[data-product-id="${productId}"]`);
                if (btn) {
                    btn.textContent = '‚ô•';
                    btn.style.background = '#d32f2f';
                    btn.style.borderColor = '#d32f2f';
                    btn.style.color = 'white';
                }
            });
        }
    })
    .catch(err => console.error('Error loading wishlist:', err));
}

// –û–±–Ω–æ–≤–∏—Ç—å UI –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è —Ç–æ–≤–∞—Ä–∞
function updateCartUIForProduct(productId, quantity) {
    const addBtn = document.querySelector(`.btn-add-cart[data-product-id="${productId}"]`);
    const qtyDiv = document.querySelector(`.cart-quantity[data-product-id="${productId}"]`);
    
    if (quantity > 0) {
        if (addBtn) addBtn.style.display = 'none';
        if (qtyDiv) {
            qtyDiv.style.display = 'flex';
            qtyDiv.querySelector('.qty-value').textContent = quantity;
        }
    } else {
        if (addBtn) addBtn.style.display = 'block';
        if (qtyDiv) qtyDiv.style.display = 'none';
    }
}

// –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω–æ–π
function setupCartControls() {
    // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
    document.querySelectorAll('.btn-add-cart').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            addToCart(productId);
        });
    });
    
    // –ö–Ω–æ–ø–∫–∏ +/-
    document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            const isPlus = this.classList.contains('qty-plus');
            if (isPlus) {
                updateQuantity(productId, 'increase');
            } else {
                updateQuantity(productId, 'decrease');
            }
        });
    });
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
function addToCart(productId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    const prefix = getLangPrefix();
    fetch(`${prefix}/cart/add/${productId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            updateCartUIForProduct(productId, data.quantity || 1);
            showToast(data.message, '{% trans "–û—Ç–∫—Ä—ã—Ç—å" %}', data.cart_url, 'success');
        } else {
            showToast(data.message || 'Error', null, null, 'error');
        }
    })
    .catch(err => console.error('Error adding to cart:', err));
}

// –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
function updateQuantity(productId, action) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    const prefix = getLangPrefix();
    fetch(`${prefix}/cart/update/${productId}/${action}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (data.quantity > 0) {
                updateCartUIForProduct(productId, data.quantity);
            } else {
                updateCartUIForProduct(productId, 0);
            }
        }
    })
    .catch(err => console.error('Error updating quantity:', err));
}

// –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function setupWishlistButtons() {
    document.querySelectorAll('.btn-wishlist').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            toggleWishlistNew(productId, this);
        });
    });
}

// –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
function toggleWishlistNew(productId, btn) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    const prefix = getLangPrefix();
    fetch(`${prefix}/wishlist/toggle/${productId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.in_wishlist) {
            btn.textContent = '‚ô•';
            btn.style.background = '#d32f2f';
            btn.style.borderColor = '#d32f2f';
            btn.style.color = 'white';
            showToast(data.message, '{% trans "–û—Ç–∫—Ä—ã—Ç—å" %}', data.wishlist_url, 'success');
        } else {
            btn.textContent = '‚ô°';
            btn.style.background = '#f8d7da';
            btn.style.borderColor = '#f5c6cb';
            btn.style.color = '#721c24';
            showToast(data.message, null, null, 'success');
        }
    })
    .catch(err => console.error('Error toggling wishlist:', err));
}

// –ú–æ–¥–∞–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
function openConfirm(url) {
    document.getElementById("confirmModal").style.display = "flex";
    document.getElementById("deleteForm").action = url;
}
function closeConfirm() {
    document.getElementById("confirmModal").style.display = "none";
}

function closeDescription() {
    document.getElementById("descriptionModal").style.display = "none";
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–∫–Ω–∞
window.onclick = function(event) {
    const modal = document.getElementById("descriptionModal");
    if (event.target == modal) {
        modal.style.display = "none";
    }
    const confirmModal = document.getElementById("confirmModal");
    if (event.target == confirmModal) {
        confirmModal.style.display = "none";
    }
}
</script>

{% endblock %}
