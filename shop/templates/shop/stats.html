{% extends "shop/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Статистика" %} - {% trans "Магазин" %}{% endblock %}

{% block content %}
<div class="container">
  <h2>{% trans "Статистика" %}</h2>

  <!-- Bar Chart -->
  <div style="margin-bottom: 40px;">
    <h3>{% trans "Данные за последние дни" %}</h3>
    <div style="background:white; padding:18px; border-radius:12px; box-shadow:0 12px 30px rgba(15,23,42,0.06);">
      <canvas id="statsCanvas" width="900" height="360" style="width:100%; height:360px; display:block;"></canvas>
    </div>
  </div>

  <!-- Pie Chart -->
  <div>
    <h3>{% trans "Распределение использования товаров" %}</h3>
    <div style="background:white; padding:18px; border-radius:12px; box-shadow:0 12px 30px rgba(15,23,42,0.06);">
      <canvas id="pieCanvas" width="900" height="480" style="width:100%; height:480px; display:block;"></canvas>
    </div>
  </div>
</div>

<script src="{% static 'shop/charts.js' %}"></script>
<script>
console.log('Stats page loaded');

setTimeout(function() {
  // Fetch real product data from cart
  fetch('/stat/itemuse1/')
    .then(r => r.json())
    .then(data => {
      console.log('Cart items data:', data);
      const pieCanvas = document.getElementById('pieCanvas');
      if (pieCanvas && typeof window.createPieChart === 'function') {
        window.createPieChart(pieCanvas, data.items, {
          colors: ['#1e40af', '#3b82f6', '#7c3aed', '#db2777', '#f59e0b', '#06b6d4', '#8b5cf6']
        });
      }
    })
    .catch(e => console.error('Pie data error:', e));
  
  // Bar chart data - 30 дней
  const barData = [];
  for (let i = 29; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    const date = day + '.' + month + '.' + year;
    
    // Разные значения для каждого дня
    const value = 400 + Math.floor(Math.random() * 400) + (i % 7) * 30;
    barData.push({date: date, value: value});
  }
  
  const barCanvas = document.getElementById('statsCanvas');
  if (barCanvas && typeof window.createBarChart === 'function') {
    console.log('Calling createBarChart with', barData.length, 'days');
    window.createBarChart(barCanvas, barData, {
      barColor: '#1e40af',
      fillColor: 'rgba(59,130,246,0.12)',
      hoverColor: '#1e3a8a',
      gridColor: '#e6eefc'
    });
  }
}, 200);
</script>

{% endblock %}
